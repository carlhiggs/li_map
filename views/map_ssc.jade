extends layout
block content
    img.center(src='/images/loading_spinner.gif')
    #sidebar.sidebar.collapsed
        // Nav tabs
        .sidebar-tabs
            ul(role='tablist')
                li
                    a(href='#home', role='tab')
                        i.fa.fa-home
                  li
                    a(href='#measures', role='tab')
                        i.fa.fa-bar-chart-o
            ul(role='tablist')
                li
                    a(href='#messages', role='tab')
                        i.fa.fa-envelope
        // Tab panes
        .sidebar-content
            #home.sidebar-pane
                h1.sidebar-header Pilot Melbourne Liveability Index
                    span.sidebar-close
                        i.fa.fa-caret-left
                span(style='font-style:italic') A policy relevant composite indicator of urban liveability, based on a socio-ecological model of health and wellbeing.
                p.
                  The pilot composite index of urban liveability in Victoria is an extension of the above research undertaken as part of the NHMRC Centre for Research Excellence in Healthy Liveable Communities, conceptualising the social determinants of health through seven domains of liveability using a socio-ecological framework: employment, food, housing, public open space, social infrastructure, transport, and walkability.  
                p.
                  The liveability index was developed to measure the distribution of accessibility and availability of the seven liveability domains hypothesized to support health and wellbeing, combining these into a policy-relevant and evidence-informed composite index which may be summarised and visualised spatially. The index will allow integrated urban planning policies for liveable neighbourhoods to be evaluated, in terms of how well they are being delivered across the Melbourne metropolitan region, the health impact of the integration of those policies and to whom. Policies which are (and are not) being delivered may be identified through dis-aggregation of the liveability index into sub-domains, enabling identification of opportunities for future investment.  Inequities in liveability across the metropolitan expanse can be interrogated through visualisation and used as exposure covariates in statistical modelling.
                p.
                  The project was initially conceived with a view to mapping spatial variation in access to built environment attributes identified as important for health and wellbeing at the ABS Statistical Area 1 (SA1) level. This is a population balanced geographic expanse ranging from 200 to 800 persons, which may loosely be considered as representative of a local neighbourhood and readily linked to both census and population health survey data. It is an artificial, administrative designation however which does not describe variation in access to amenities within the SA1 area. It therefore offers limited options for aggregation to other geographical scales such as local government areas (LGAs) or meshblocks (the smallest area unit used by the ABS, in general containing either 30-60 households, or none) which can have important implications when considering spatial exposure. Hence, instead of using population weighted centroids at the SA1 level as our unit of analysis, the pilot study was used as an opportunity to test the feasibility of parcel level analysis in the first instance.
                p. 
                  The two important benefits of a parcel-based approach to indicator construction are: 1) the ability to flexibly aggregate to any sized administrative extent as required; and 2) being able to estimate the within area variation and relate this to the between area variation, allowing for estimation of the heterogeneity that area-level aggregation occludes. 
                p.
                  #[a(href="/..") Return to the pilove Liveability Index visualisation entry page.]
            #measures.sidebar-pane
                h1.sidebar-header Indicators
                    span.sidebar-close
                        i.fa.fa-caret-left
                h3.
                  Liveability
                p.
                  Hard- or soft- cutoff version of the pilot Liveability Index; a score of 100 is average, with usual expected range of about 80 to 120.  Composite indicator construction is based on:
                span(style='font-style:italic') De Muro, P., et al. (2011). "Composite Indices of Development and Poverty: An Application to MDGs." Social Indicators Research 104(1): 1-18.
                h3.
                  Walkability Index
                p.
                  A sum of z-scores (standardised measures) of dwelling density, street connectivity and daily living score.  The daily living score is an indicator of land use mix, formed through the sum of within-buffer access to a Public transport stop, a convenience destinations, and a supermarket.  See: 
                span(style='font-style:italic') Badland, H., et al. (2016). "Identifying, creating, and testing urban planning measures for transport walking: Findings from the Australian national liveability study." Journal of Transport & Health 5: 151-162.
                h3.
                  Social Infrastructure mix
                p.
                  A social infrastructure mix score was calculated as the sum of destination access to 15 types of destination, resulting in a score from 0 to 15:   Community Centre; Museum / Art Gallery; Cinema/Theatre; Libraries; Childcare; Childcare (Out Of School; State Primary Schools; State Secondary Schools; Aged Care; Community Health Centres; Dentists; GP Clinics; Maternal Child Health; Pharmacy; Swimming Pools; and Sport.
                h3.
                  PT access meets policy
                p.
                  A policy-based public transport indicator based on Victorian government planning guidelines stipulating access to a stop on the public transport network within mode-specific cut-off distances: either a bus stop within 400m, a tram stop within 600m or a train station within 800m.  See clause 56.03-1 in:
                span(style='font-style:italic') Department of Environment, Land, Water and Planning. 2006. "Victorian Planning Provisions, Clause 56.03: Liveable and Sustainable Communities." Report. Victorian Government. 
                h3.
                  Access to public open space > 1.5 Ha in size within 400m 
                p.
                  The public open space (POS) access indicator is based on a policy recommendation that access to large public open space should be available within 400m of a residence.  The public open space indicator was only calculated in soft form, which provides more nuance as an indicator of access, given the high-POS access setting of the Melbourne metropolitan region.
                span(style='font-style:italic') Sugiyama, T., et al. (2010). "Associations Between Recreational Walking and Attractiveness, Size, and Proximity of Neighborhood Open Spaces." American Journal of Public Health 100(9): 1752-1757.
                span(style='font-style:italic') Sugiyama, T., et al. (2014). "Public open spaces and walking for recreation: Moderation by attributes of pedestrian environments." Preventive Medicine 62: 25-29.
                h3.
                  Air pollution
                p.
                   As indicated by Mesh Block level predicted nitrogen dioxide (NO2); included in the liveability index as a reverse-scaled measure (air quality). See: 
                span(style='font-style:italic') Knibbs, L. D., et al. (2014). "A national satellite-based land-use regression model for air pollution exposure assessment in Australia." Environ Res 135: 204-211. 
                h3.
                  Affordable housing
                p.
                  30-40 measure of housing affordability at the SA1-level:
                span(style='font-style:italic') "The ABS defines an area as having 'affordable' housing if the lowest 40% of household incomes in a given area spend < 30% of gross income on mortgage / rental payments [35]. This measure is commonly referred to as the 30/40 rule [36]. Accordingly, the ABS generated this customised measure as a proportion for each local area, which was collapsed into quartiles." -- Badland, H., et al. (2017). "Examining associations between area-level spatial measures of housing with selected health and wellbeing behaviours and outcomes in an urban context." Health & Place 43: 17-24.
                h3.
                  Proportion live/work in same SA3
                p.
                  Proportion of employed persons living and working in the same SA3 (measured at SA2 level).  See: 
                span(style='font-style:italic') Badland, H., et al. (2015). "Conceptualising and Measuring Spatial Indicators of Employment Through a Liveability Lens." Social Indicators Research: 1-12.
            #messages.sidebar-pane
                h1.sidebar-header Contact
                    span.sidebar-close
                        i.fa.fa-caret-left
                p.
                  For further information and contact details, please visit the #[a(href="http://cur.org.au/project/developing-pilot-victorian-urban-liveability-index/", target="_blank") pilot Liveability Index project] and the #[a(href="http://cur.org.au/research-programs/healthy-liveable-cities-group/", target="_blank") Healthy Liveable Cities Group] at the official #[a(href="http://cur.org.au/", target="_blank") RMIT Centre for Urban Research] web page.
    #map.sidebar-map
    script.
        var myData = !{JSON.stringify(jsonData)};
        // Create variable to hold map element, give initial settings to map
        var map = L.map('map',{ center: [-37.8078244,144.9625175], zoom: 12});
        
        // Add CartoDB.Positron tile layer to map element
        var bmap = 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
        var bmap_attrib = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
        // var bmap = 'https://api.mapbox.com/styles/v1/gorgonspeaks/cj6aik97139zb2snsdqkdfi4d/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ29yZ29uc3BlYWtzIiwiYSI6ImNqNW9qM2t0OTAwZ2Qyd28wMGswNjZ0NWwifQ.Sp_o2zYX_JUZNkcIyXIdMw'
        // var bmap_attrib = '&copy; <a href="http://www.openstreetmap.org/copyright">Health Liveable Cities Group, RMIT</a>'
        tiles = L.tileLayer(bmap, { attribution: bmap_attrib}).addTo(map);
        
        function formatProp(p) {
            return p >= 0.01 ? p:
                   p >  0    ? '< 0.01':
                0;
        }
        
        // control that shows state info on hover
        var info = L.control();
        
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info summarybox');
            this.update();
            return this._div;
        };
        
        var table_header = '<tr><td><div id="Suburb"><b>Suburb: </b>Hover over an area...</div></td></tr><tr><td><div id="LGA"><b>LGA: </b>-</div></td></tr>'
        
        var radio_table = '<table class="radio-table"><tr><td>&nbsp;</td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="15";" checked /></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="16";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="17";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="18";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="19";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="20";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="21";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="22";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="23";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="24";" /></label></div></td></tr><tr><td><div class="radio"><label><input type="radio" name="ind" id="25";" /></label></div></td></tr></table>'
        
        var indicator_table = '<table class="g-pop-table" width="420" height="300"><col width="0"><col width="240"><col width="90"><col width="90"><tbody><tr><td></td><td><b>Indicator</b></td><td align="center"><b>Average</b></td><td align="center"><b>Score (/100)</b></td></tr><tr><td style="position: relative;"><div class="g-ind-main" id="b_li" style="width:0px;"></div></td><td><i><b>Liveability</b></i></td><td align="center"><b></b></td><td align="center"><b><div id="p_li">-</div></b></td></tr><tr><td style="position: relative;"><div class="g-ind-sub" id="b_wa" style="width:0px;"></div></td><td><i>&emsp;Walkability Index</i></td><td align="center"></td><td align="center"><div id="p_wa">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-alt" id="b_dl" style="width:0px";></div></td><td><i class=".subindicator">&emsp;&emsp;- Daily Living (/3)</i></td><td align="center"><div id="r_dl">-</div></td><td align="center"><div id="p_dl">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-alt" id="b_dd" style="width:0px";"></div></td><td><i class=".subindicator">&emsp;&emsp;- Dwellings per Ha</i></td><td align="center"><div id="r_dd">-</div></td><td align="center"><div id="p_dd">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-alt" id="b_sc" style="width:0px";"></div></td><td><i class=".subindicator">&emsp;&emsp;- 3+ way street connections per Ha</i></td><td align="center"><div id="r_sc">-</div></td><td align="center"><div id="p_sc">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-sub" id="b_si" style="width:0px";"></div></td><td><i>&emsp;Social infrastructure mix (/16)</i></td><td align="center"><div id="r_si">-</div></td>  <td align="center"><div id="p_si">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-sub" id="b_pt" style="width:0px";"></div></td><td><i>&emsp;PT access meets policy (%)</i></td><td align="center"><div id="r_pt">-</div></td><td align="center"><div id="p_pt">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-sub" id="b_po" style="width:0px";"></div></td><td><i>&emsp;POS &ge; 1.5Ha within 400m (%)</i></td><td align="center"><div id="r_po">-</div></td><td align="center"><div id="p_po">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-sub" id="b_pr" style="width:0px";"></div></td><td><i>&emsp;Air quality (rev. Mesh Block NO&#x2082; ppb.)</i></td><td align="center"><div id="r_pr">-</div></td><td align="center"><div id="p_pr">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-sub" id="b_af" style="width:0px";"></div></td><td><i>&emsp;Affordable housing (30/40 rule, SA1 %)</i></td><td align="center"><div id="r_af">-</div></td><td align="center"><div id="p_af">-</div></td></tr><tr><td style="position: relative;"><div class="g-ind-sub" id="b_lw" style="width:0px";"></div></td><td><i>&emsp;Live & work w/in SA3 (SA2 %)</i></td><td align="center"><div id="r_lw">-</div></td><td align="center"><div id="p_lw">-</div></td></tr></tbody></table>'
        
        info.update = function (props) {
            this._div.innerHTML = '<h4>Pilot Liveability Index (Melbourne, 2011)</h4><table class="over-table"><col width="460"><tbody>' + table_header + '<tr><table class="holder-table"><col width="10"><col width="450"><tbody><td>' + radio_table + '</td><td>' + indicator_table + '</td></tbody></table>';
        };
  
        info.addTo(map);
        
        function requantile(p,num) {
            return Math.floor((p-1)/num)+1;
        }
   
        // get color depending on population density value
        function getColor(p) {
            // // Decile colours
            return  p > 90 ? '#081D58':
                    p > 80 ? '#22318D':
                    p > 70 ? '#2455A4':
                    p > 60 ? '#2280B8':
                    p > 50 ? '#34A5C2':
                    p > 40 ? '#61C0C0':
                    p > 30 ? '#99D6B9':
                    p > 20 ? '#D0ECB3':
                    p > 10 ? '#EFF9B5':
                    p > 0 ? '#FFFFD9':
                '#f7f7f7';
        }
        
        // redefine console.log for variable tracking
        console.oldLog = console.log;
        console.log = function(value){
            console.oldLog(value);
            window.$log = value;
            };
        
        console.log("15");
        
        function style(feature) {
            // old return 
            // fillColor: getColor(feature.properties.f15)
            // fillColor: getColor(current_property{checked_indicator})
            return {
                weight: 1,
                color: 'white',
                fillOpacity: 0.7,
                fillColor: getColor(eval("feature.properties.f"+$log))
            };
        }

        
        function highlightFeature(e) {
            var layer = e.target;
            // var checked_indicator = document.querySelector('input[name="ind"]:checked').id;
            // var current_property = {};
        
            layer.setStyle({
                weight: 3,
                color: '#d65454',
                dashArray: '',
                fillOpacity: 0.7
            });
        
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
            hover(layer.feature.properties)
            // info.update(layer.feature.properties);
        }
        
        var geojson;
        
        function bgWidth(value){
          return (value/100)*230 +'px'
        }
        
        function hover(props) {
            // update percentiles
            // document.getElementById('SA1').innerHTML = props.f1;
            document.getElementById('Suburb').innerHTML = "<b>Suburb: " + props.f2 + "</b>";
            document.getElementById('LGA').innerHTML = "<b>LGA:</b> " + props.f3;
            document.getElementById('p_li').innerHTML = props.f15;
            document.getElementById('p_wa').innerHTML = props.f16;
            document.getElementById('p_dl').innerHTML = props.f17;
            document.getElementById('p_dd').innerHTML = props.f18;
            document.getElementById('p_sc').innerHTML = props.f19;
            document.getElementById('p_si').innerHTML = props.f20;
            document.getElementById('p_pt').innerHTML = props.f21;
            document.getElementById('p_po').innerHTML = props.f22;
            document.getElementById('p_pr').innerHTML = props.f23;
            document.getElementById('p_af').innerHTML = props.f24;
            document.getElementById('p_lw').innerHTML = props.f25;
            
            // updated raw values
            // document.getElementById('p_li').innerHTML = props.f4;
            // document.getElementById('p_wa').innerHTML = props.f5;
            document.getElementById('r_dl').innerHTML = props.f6;
            document.getElementById('r_dd').innerHTML = props.f7;
            document.getElementById('r_sc').innerHTML = props.f8;
            document.getElementById('r_si').innerHTML = props.f9;
            document.getElementById('r_pt').innerHTML = props.f10;
            document.getElementById('r_po').innerHTML = props.f11;
            document.getElementById('r_pr').innerHTML = props.f12;
            document.getElementById('r_af').innerHTML = props.f13;
            document.getElementById('r_lw').innerHTML = props.f14;
            
            // update width for graph bars
            document.getElementById('b_li').style.width = bgWidth(props.f15);
            document.getElementById('b_wa').style.width = bgWidth(props.f16);
            document.getElementById('b_dl').style.width = bgWidth(props.f17);
            document.getElementById('b_dd').style.width = bgWidth(props.f18);
            document.getElementById('b_sc').style.width = bgWidth(props.f19);
            document.getElementById('b_si').style.width = bgWidth(props.f20);
            document.getElementById('b_pt').style.width = bgWidth(props.f21);
            document.getElementById('b_po').style.width = bgWidth(props.f22);
            document.getElementById('b_pr').style.width = bgWidth(props.f23);
            document.getElementById('b_af').style.width = bgWidth(props.f24);
            document.getElementById('b_lw').style.width = bgWidth(props.f25);
        }
        
        function resetHighlight(e) {
            geojson.resetStyle(e.target);
            // info.update();
        }
        
        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }
        
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight
                // click: zoomToFeature
            });  
          layer.bindPopup('<table class="g-pop-table" width="420" height="300"><col width="0"><col width="240"><col width="90"><col width="90"><tbody><tr><td></td><td><b>Suburb: </b>' + feature.properties.f2 + '</td><td></td><td></td>  </tr><tr><td></td><td><b>LGA: </b>' + feature.properties.f3 +'</td><td></td><td></td></tr><tr></tr><tr><td></td><td><b>Indicator</b></td><td align="center"><b>Average</b></td><td align="center"><b>Score (/100)</b></td></tr><tr><td style="position: relative;"><div class="g-ind-main" style="width:'+  (feature.properties.f15/100)*230 +'px;"></div></td><td><i><b>Liveability</b></i></td><td align="center"><b></b></td>   <td align="center"><b>' + feature.properties.f15 +  '</b></td></tr><tr><td style="position: relative;"><div class="g-ind-sub" style="width:'+  (feature.properties.f16/100)*230 +'px;"></div></td><td><i>&emsp;Walkability Index</i></td><td align="center"></td>   <td align="center">' + feature.properties.f16 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-alt" style="width:'+  (feature.properties.f17/100)*230 +'px; height: 100% ; background: #ffb3b3;"></div></td><td><i class=".subindicator">&emsp;&emsp;- Daily Living (/3)</i></td><td align="center">' + feature.properties.f6 + '</td>   <td align="center">' + feature.properties.f17 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-alt" style="width:'+  (feature.properties.f18/100)*230 +'px; height: 100% ; background: #ffb3b3;"></div></td><td><i class=".subindicator">&emsp;&emsp;- Dwellings per Ha</i></td><td align="center">' + feature.properties.f7 + '</td>   <td align="center">' + feature.properties.f18 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-alt" style="width:'+  (feature.properties.f19/100)*230 +'px; height: 100% ; background: #ffb3b3;"></div></td><td><i class=".subindicator">&emsp;&emsp;- 3+ way street connections per Ha</i></td><td align="center">' + feature.properties.f8 + '</td>   <td align="center">' + feature.properties.f19 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-sub" style="width:'+  (feature.properties.f20/100)*230 +'px;"></div></td><td><i>&emsp;Social infrastructure mix (/16)</i></td><td align="center">' + feature.properties.f9 + '</td>  <td align="center">' + feature.properties.f20 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-sub" style="width:'+  (feature.properties.f21/100)*230 +'px;"></div></td><td><i>&emsp;PT access meets policy (%)</i></td><td align="center">' + feature.properties.f10 + '</td>   <td align="center">' + feature.properties.f21 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-sub" style="width:'+  (feature.properties.f22/100)*230 +'px;"></div></td><td><i>&emsp;POS &ge; 1.5Ha within 400m (%)</i></td><td align="center">' + feature.properties.f11 + '</td><td align="center">' + feature.properties.f22 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-sub" style="width:'+  (feature.properties.f23/100)*230 +'px;"></div></td><td><i>&emsp;Air quality (rev. Mesh Block NO&#x2082; ppb.)</i></td><td align="center">' + feature.properties.f12 + '</td><td align="center">' + feature.properties.f23 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-sub" style="width:'+  (feature.properties.f24/100)*230 +'px;"></div></td><td><i>&emsp;Affordable housing (30/40 rule, SA1 %)</i></td><td align="center">' + feature.properties.f13 + '</td><td align="center">' + feature.properties.f24 +  '</td></tr><tr><td style="position: relative;"><div class="g-ind-sub" style="width:'+  (feature.properties.f25/100)*230 +'px;"></div></td><td><i>&emsp;Live & work w/in SA3 (SA2 %)</i></td><td align="center">' + feature.properties.f14 + '</td><td align="center">' + feature.properties.f25 +  '</td></tr></tbody></table>', {
              maxWidth : 490
          });
        }
        
        // add polygon data
        geojson = L.geoJson(myData, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);
        
        function updateColors(){
            geojson.eachLayer(function(layer){
                geojson.setStyle(style); 
            }); 
            // setTimeout(updateColors, 1500);
        } 
        
        // // Create event listener for the active indicator selection
        // document.body.addEventListener("click", function(e) {
            // // e.target was the clicked element
            // if(e.target && e.target.type == "radio") {
                // console.log(e.target.id); 
                // document.getElementById("activeTitle").innerHTML = e.target.innerHTML;
                // updateColors();
                // }
            // });
        $(document).ready(function() {
             $('input[type=radio][name=ind]').change(function() {
                 console.log(this.id); 
                 updateColors();
             });
         });
        // add attribution
        map.attributionControl.addAttribution('Liveability Index &copy; <a href="http://cur.org.au/research-programs/healthy-liveable-cities-group/">Healthy Liveable Cities Group, RMIT</a>');
        
        
        // add mini-map
        var bmap2 = new L.TileLayer(bmap, {minZoom: 0, maxZoom: 13, attribution: bmap_attrib});
        var miniMap = new L.Control.MiniMap(bmap2).addTo(map);    
        
        // Style and add legend
        var legend = L.control({position: 'bottomright'});
        
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                quantiles = [100,90,80,70,60,50,40,30,20,10],
                labels = [],
                quantile = ['100 High','90','80','70','60','50','40','30','20','10 Low'];
                labels.push('<table style="table-layout:fixed;"><col width="20"><col width="8"><col width="80"><tr><td></td><td></td><td><b><div id="activeTitle" z>Liveability</div></b></td>');
            for (var i = 0; i < quantiles.length; i++) {
                labels.push('<tr><td style="background:' + getColor(quantiles[i]) + '"></td><td></td><td>' + quantile[i] + '</td>');
            }
            div.innerHTML = labels.join('</tr>')+ '</tr></table>';
            return div;
        };
     
        legend.addTo(map);
        
        // add scale bar
        L.control.scale().addTo(map);
        // add full screen toggle
        map.addControl(new L.Control.Fullscreen());
        
        // add sidebar
        var sidebar = L.control.sidebar('sidebar').addTo(map);
        
        
        // D3 plot
        // to be implemented: histogram of selected indicator
        
        // add save to .png functions
        var printer = L.easyPrint({
          title: 'Download snapshot to png (ctr+alt+s)',
            tileLayer: tiles,
            filename: 'LiveabilityIndexExport',
            exportOnly: true,
            hideControlContainer: false
        }).addTo(map);
        
        
        function manualPrint () {
            printer.printMap('CurrentSize', 'MyManualPrint')
        }
        
        document.onkeyup=function(e){
          var e = e || window.event; // for IE to cover IEs window event-object
          if(e.altKey && e.which == 83) {
            printer.printMap('CurrentSize', 'LiveabilityIndexExport');
            }
          }